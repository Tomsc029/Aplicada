import serial
import pandas as pd
import matplotlib.pyplot as plt

PUERTO_COM = 'COM3'   # Ajusta segÃºn tu PC
BAUDRATE = 115200
ARCHIVO = 'gps_datos.csv'

puerto = serial.Serial(PUERTO_COM, BAUDRATE)
datos = []

try:
    print("ðŸ“¡ Capturando datos GPS... Presiona Ctrl+C para detener.")
    while True:
        linea = puerto.readline().decode().strip()
        if linea.count(",") == 2:  # formato tiempo,lat,lon
            tiempo, lat, lon = linea.split(",")
            datos.append({'Tiempo': float(tiempo),
                          'Latitud': float(lat),
                          'Longitud': float(lon)})
except KeyboardInterrupt:
    print("ðŸ›‘ Captura detenida por el usuario.")
    df = pd.DataFrame(datos)
    df.to_csv(ARCHIVO, index=False)
    print(f"âœ… Datos guardados en {ARCHIVO}")
    puerto.close()

    # Graficar scatter plot
    plt.figure(figsize=(6,6))
    plt.scatter(df['Longitud'], df['Latitud'], color='blue', marker='o')

    # Etiquetas de cada punto
    for i, row in df.iterrows():
        plt.text(row['Longitud'], row['Latitud'], str(int(row['Tiempo'])), fontsize=8, ha='right')

    plt.xlabel('Longitud')
    plt.ylabel('Latitud')
    plt.title('Puntos GPS capturados con ESP32')
    plt.grid(True)
    plt.show()
